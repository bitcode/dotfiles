---
# Test playbook for idempotent GNU Stow deployment system
# Verifies that repeated executions are fast and show correct status

- name: Test Idempotent GNU Stow Deployment
  hosts: localhost
  connection: local
  gather_facts: true
  become: false

  vars:
    profile: "enterprise"
    environment_type: "enterprise"
    ansible_user: "mdrozrosario"
    ansible_user_dir: "/Users/mdrozrosario"

  tasks:
    - name: "ğŸ§ª TESTING IDEMPOTENT GNU STOW DEPLOYMENT"
      debug:
        msg: |
          Testing the idempotent GNU Stow deployment system
          ğŸ¯ Objective: Verify fast repeated executions with accurate status reporting
          ğŸ“Š Expected: Mostly "SKIPPED" status on second run
          âš¡ Performance: Significant time savings on repeated deployments
          
          Profile: {{ profile }}
          Environment: {{ environment_type }}

    - name: "ğŸ”„ First Deployment Run (Baseline)"
      debug:
        msg: |
          Performing first deployment run to establish baseline
          This run may show "ADDED" or "CHANGED" status for new symlinks
      tags: ['first_run']

    - name: Record first run start time
      set_fact:
        first_run_start: "{{ ansible_date_time.epoch }}"
      tags: ['first_run']

    - name: "ğŸ”— Execute first idempotent GNU Stow deployment"
      include_role:
        name: dotfiles
      vars:
        dotfiles:
          enabled: true
          repository: ""  # Auto-detected
          backup_existing: true
          backup_directory: "/Users/mdrozrosario/.dotsible/backups"
          symlink_strategy: "force"
          create_directories: true
          cleanup_broken_links: true
      tags: ['first_run', 'dotfiles']

    - name: Record first run end time and results
      set_fact:
        first_run_end: "{{ ansible_date_time.epoch }}"
        first_run_duration: "{{ (ansible_date_time.epoch | int) - (first_run_start | int) }}"
        first_run_stats: "{{ execution_stats | default({}) }}"
      tags: ['first_run']

    - name: "ğŸ“Š First Run Results"
      debug:
        msg: |
          ğŸ”„ FIRST DEPLOYMENT RUN COMPLETED
          ================================
          
          â±ï¸  Duration: {{ first_run_duration }}s
          ğŸ“Š Applications: {{ first_run_stats.apps_skipped | default(0) + first_run_stats.apps_processed | default(0) }}
          âœ… Skipped: {{ first_run_stats.apps_skipped | default(0) }}
          ğŸ”„ Processed: {{ first_run_stats.apps_processed | default(0) }}
          
          ğŸ”— Symlinks:
          â€¢ âœ… SKIPPED: {{ first_run_stats.symlinks_skipped | default(0) }}
          â€¢ ğŸ”„ CHANGED: {{ first_run_stats.symlinks_changed | default(0) }}
          â€¢ â• ADDED: {{ first_run_stats.symlinks_added | default(0) }}
          â€¢ ğŸ”§ FIXED: {{ first_run_stats.symlinks_fixed | default(0) }}
          â€¢ âŒ FAILED: {{ first_run_stats.symlinks_failed | default(0) }}
      tags: ['first_run']

    - name: "â³ Brief pause between runs"
      pause:
        seconds: 2
        prompt: "Pausing briefly before second run to ensure timestamp differences..."
      tags: ['second_run']

    - name: "ğŸ”„ Second Deployment Run (Idempotency Test)"
      debug:
        msg: |
          Performing second deployment run to test idempotency
          This run should show mostly "SKIPPED" status for optimal performance
      tags: ['second_run']

    - name: Record second run start time
      set_fact:
        second_run_start: "{{ ansible_date_time.epoch }}"
      tags: ['second_run']

    - name: "ğŸ”— Execute second idempotent GNU Stow deployment"
      include_role:
        name: dotfiles
      vars:
        dotfiles:
          enabled: true
          repository: ""  # Auto-detected
          backup_existing: true
          backup_directory: "/Users/mdrozrosario/.dotsible/backups"
          symlink_strategy: "force"
          create_directories: true
          cleanup_broken_links: true
      tags: ['second_run', 'dotfiles']

    - name: Record second run end time and results
      set_fact:
        second_run_end: "{{ ansible_date_time.epoch }}"
        second_run_duration: "{{ (ansible_date_time.epoch | int) - (second_run_start | int) }}"
        second_run_stats: "{{ execution_stats | default({}) }}"
      tags: ['second_run']

    - name: "ğŸ“Š Second Run Results"
      debug:
        msg: |
          ğŸ”„ SECOND DEPLOYMENT RUN COMPLETED
          =================================
          
          â±ï¸  Duration: {{ second_run_duration }}s
          ğŸ“Š Applications: {{ second_run_stats.apps_skipped | default(0) + second_run_stats.apps_processed | default(0) }}
          âœ… Skipped: {{ second_run_stats.apps_skipped | default(0) }}
          ğŸ”„ Processed: {{ second_run_stats.apps_processed | default(0) }}
          
          ğŸ”— Symlinks:
          â€¢ âœ… SKIPPED: {{ second_run_stats.symlinks_skipped | default(0) }}
          â€¢ ğŸ”„ CHANGED: {{ second_run_stats.symlinks_changed | default(0) }}
          â€¢ â• ADDED: {{ second_run_stats.symlinks_added | default(0) }}
          â€¢ ğŸ”§ FIXED: {{ second_run_stats.symlinks_fixed | default(0) }}
          â€¢ âŒ FAILED: {{ second_run_stats.symlinks_failed | default(0) }}
      tags: ['second_run']

    - name: Calculate idempotency performance metrics
      set_fact:
        performance_improvement: "{{ ((first_run_duration | int) - (second_run_duration | int)) / (first_run_duration | int) * 100 }}"
        idempotency_ratio: "{{ (second_run_stats.symlinks_skipped | default(0)) / ((second_run_stats.symlinks_skipped | default(0)) + (second_run_stats.symlinks_changed | default(0)) + (second_run_stats.symlinks_added | default(0))) * 100 }}"
      tags: ['analysis']

    - name: "ğŸ¯ IDEMPOTENCY TEST ANALYSIS"
      debug:
        msg: |
          ğŸ¯ IDEMPOTENT GNU STOW DEPLOYMENT TEST RESULTS
          =============================================
          
          ğŸ“Š Performance Comparison:
          â€¢ First Run Duration: {{ first_run_duration }}s
          â€¢ Second Run Duration: {{ second_run_duration }}s
          â€¢ Performance Improvement: {{ performance_improvement | round(1) }}%
          
          ğŸ”— Idempotency Analysis:
          â€¢ Second Run Skipped: {{ second_run_stats.symlinks_skipped | default(0) }}
          â€¢ Second Run Changed: {{ second_run_stats.symlinks_changed | default(0) }}
          â€¢ Second Run Added: {{ second_run_stats.symlinks_added | default(0) }}
          â€¢ Idempotency Ratio: {{ idempotency_ratio | round(1) }}%
          
          âœ… Success Criteria Verification:
          {% if (second_run_stats.symlinks_skipped | default(0)) > (second_run_stats.symlinks_changed | default(0)) + (second_run_stats.symlinks_added | default(0)) %}
          âœ… PASSED: More symlinks skipped than changed (idempotent behavior)
          {% else %}
          âŒ FAILED: Too many changes on second run (not idempotent)
          {% endif %}
          
          {% if (second_run_duration | int) <= (first_run_duration | int) %}
          âœ… PASSED: Second run was faster or equal (performance optimization)
          {% else %}
          âŒ FAILED: Second run was slower (performance regression)
          {% endif %}
          
          {% if (second_run_stats.symlinks_failed | default(0)) == 0 %}
          âœ… PASSED: No failed operations (reliability)
          {% else %}
          âŒ FAILED: {{ second_run_stats.symlinks_failed }} operations failed
          {% endif %}
          
          ğŸ‰ Overall Status: {{ 'SUCCESS' if (
            (second_run_stats.symlinks_skipped | default(0)) > (second_run_stats.symlinks_changed | default(0)) + (second_run_stats.symlinks_added | default(0)) and
            (second_run_duration | int) <= (first_run_duration | int) and
            (second_run_stats.symlinks_failed | default(0)) == 0
          ) else 'NEEDS ATTENTION' }}
          
          ğŸ’¡ Expected Behavior:
          â€¢ First run: May show ADDED/CHANGED for new symlinks
          â€¢ Second run: Should show mostly SKIPPED for existing symlinks
          â€¢ Performance: Second run should be significantly faster
          â€¢ Reliability: No failed operations on either run
          
          ğŸ“‹ Reports Generated:
          â€¢ Detailed Report: ~/.dotsible/IDEMPOTENT_STOW_REPORT.txt
          â€¢ Backup Manifests: ~/.dotsible/backups/
          â€¢ Validation Reports: ~/.dotsible/VALIDATION_REPORT.txt
      tags: ['analysis']

    - name: "ğŸ” Verify report files were created"
      stat:
        path: "{{ item }}"
      register: report_files_check
      loop:
        - "/Users/mdrozrosario/.dotsible/IDEMPOTENT_STOW_REPORT.txt"
        - "/Users/mdrozrosario/.dotsible/VALIDATION_REPORT.txt"
      tags: ['verification']

    - name: "ğŸ“‹ Report Files Status"
      debug:
        msg: |
          ğŸ“‹ Generated Report Files:
          {% for file_check in report_files_check.results %}
          â€¢ {{ file_check.item | basename }}: {{ 'EXISTS' if file_check.stat.exists else 'MISSING' }}
          {% endfor %}
          
          ğŸ“– To view detailed results:
          cat ~/.dotsible/IDEMPOTENT_STOW_REPORT.txt
          cat ~/.dotsible/VALIDATION_REPORT.txt
      tags: ['verification']
