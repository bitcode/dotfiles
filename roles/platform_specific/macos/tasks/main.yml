---
# macOS platform-specific setup tasks extracted from macsible.yaml
- name: macOS platform setup initialization
  debug:
    msg: |
      üçé macOS Platform Configuration Starting
      ========================================
      ‚Ä¢ Homebrew packages: {{ homebrew_packages | length }} packages
      ‚Ä¢ Homebrew casks: {{ homebrew_casks | length }} applications
      ‚Ä¢ Mac App Store apps: {{ mac_app_store_apps | length }} applications
      ‚Ä¢ Manual installations: {{ manual_installations | length }} tools
      ‚Ä¢ NPM global packages: {{ npm_global_packages | length }} packages
      ========================================

# === SYSTEM PREREQUISITES ===
- name: Check if Xcode Command Line Tools are installed
  stat:
    path: /Library/Developer/CommandLineTools/usr/bin/git
  register: xcode_tools_installed

- name: Install Xcode Command Line Tools
  shell: xcode-select --install
  when: not xcode_tools_installed.stat.exists
  register: xcode_install_result
  failed_when:
    - xcode_install_result.rc != 0
    - "'already installed' not in xcode_install_result.stderr"

- name: Check if Homebrew is installed
  stat:
    path: /opt/homebrew/bin/brew
  register: homebrew_installed

- name: Install Homebrew
  shell: |
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  when: not homebrew_installed.stat.exists
  environment:
    NONINTERACTIVE: 1

- name: Check if Rosetta 2 is needed (Apple Silicon)
  shell: uname -m
  register: cpu_arch
  changed_when: false

- name: Check if Rosetta 2 is installed
  stat:
    path: /Library/Apple/usr/share/rosetta
  register: rosetta_installed
  when: cpu_arch.stdout == "arm64"

- name: Install Rosetta 2 for Apple Silicon
  shell: softwareupdate --install-rosetta --agree-to-license
  when:
    - cpu_arch.stdout == "arm64"
    - not rosetta_installed.stat.exists

# === HOMEBREW PACKAGES ===
- name: Check which Homebrew packages are already installed
  shell: brew list {{ item }} 2>/dev/null
  register: homebrew_package_check
  failed_when: false
  changed_when: false
  loop: "{{ homebrew_packages }}"

- name: Display Homebrew package status
  debug:
    msg: "{{ item.item }}: {{ 'INSTALLED' if item.rc == 0 else 'MISSING' }}"
  loop: "{{ homebrew_package_check.results }}"
  when: item.rc != 0  # Only show missing packages to reduce output

- name: Install missing Homebrew packages
  community.general.homebrew:
    name: "{{ item.item }}"
    state: present
  when: item.rc != 0
  loop: "{{ homebrew_package_check.results }}"

- name: Homebrew packages summary
  debug:
    msg: |
      üì¶ Homebrew Packages Summary:
      ‚Ä¢ Total packages: {{ homebrew_packages | length }}
      ‚Ä¢ Already installed: {{ homebrew_package_check.results | selectattr('rc', 'equalto', 0) | list | length }}
      ‚Ä¢ Newly installed: {{ homebrew_package_check.results | selectattr('rc', 'ne', 0) | list | length }}

# === HOMEBREW CASKS ===
- name: Check which Homebrew casks are already installed
  shell: brew list --cask {{ item }} 2>/dev/null
  register: homebrew_cask_check
  failed_when: false
  changed_when: false
  loop: "{{ homebrew_casks }}"

- name: Display Homebrew cask status
  debug:
    msg: "{{ item.item }}: {{ 'INSTALLED' if item.rc == 0 else 'MISSING' }}"
  loop: "{{ homebrew_cask_check.results }}"
  when: item.rc != 0  # Only show missing casks to reduce output

- name: Install missing Homebrew casks
  community.general.homebrew_cask:
    name: "{{ item.item }}"
    state: present
    accept_external_apps: true
  when: item.rc != 0
  loop: "{{ homebrew_cask_check.results }}"
  register: homebrew_cask_install_result
  retries: 3
  delay: 10
  until: homebrew_cask_install_result is succeeded
  failed_when: false  # Don't fail immediately, let us handle errors

- name: Report Homebrew cask installation failures
  debug:
    msg: |
      ‚ùå Failed to install cask: {{ item.item.item }}
      Error: {{ item.msg | default('Unknown error') }}
      {% if item.stderr is defined and item.stderr %}
      stderr: {{ item.stderr }}
      {% endif %}
      {% if item.stdout is defined and item.stdout %}
      stdout: {{ item.stdout }}
      {% endif %}
  loop: "{{ homebrew_cask_install_result.results | default([]) }}"
  when:
    - homebrew_cask_install_result.results is defined
    - item.failed | default(false)

- name: Fail if critical casks could not be installed
  fail:
    msg: |
      Critical Homebrew casks failed to install. See errors above.
      Failed casks: {{ homebrew_cask_install_result.results | selectattr('failed', 'defined') | selectattr('failed') | map(attribute='item.item') | list | join(', ') }}
  when:
    - homebrew_cask_install_result.results is defined
    - homebrew_cask_install_result.results | selectattr('failed', 'defined') | selectattr('failed') | list | length > 0

- name: Homebrew casks summary
  debug:
    msg: |
      üç∫ Homebrew Casks Summary:
      ‚Ä¢ Total casks: {{ homebrew_casks | length }}
      ‚Ä¢ Already installed: {{ homebrew_cask_check.results | selectattr('rc', 'equalto', 0) | list | length }}
      ‚Ä¢ Newly installed: {{ homebrew_cask_check.results | selectattr('rc', 'ne', 0) | list | length }}

# === MANUAL INSTALLATIONS ===
- name: Check if Rust is installed
  shell: rustc --version
  register: rust_check
  failed_when: false
  changed_when: false

- name: Install Rust
  shell: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  when: rust_check.rc != 0
  environment:
    CARGO_HOME: "{{ ansible_env.HOME }}/.cargo"
    RUSTUP_HOME: "{{ ansible_env.HOME }}/.rustup"

# === NODE VERSION MANAGER (NVM) INSTALLATION ===
- name: Check if Node Version Manager (nvm) is installed
  stat:
    path: "{{ ansible_env.HOME }}/.nvm/nvm.sh"
  register: nvm_installed

- name: Install Node Version Manager (nvm)
  shell: curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
  when: not nvm_installed.stat.exists

- name: Check if nvm configuration exists in .zshrc
  shell: grep -q "NVM_DIR" "{{ ansible_env.HOME }}/.zshrc" 2>/dev/null
  register: nvm_config_exists
  failed_when: false
  changed_when: false

- name: Create .zshrc if it doesn't exist
  file:
    path: "{{ ansible_env.HOME }}/.zshrc"
    state: touch
    mode: '0644'
  when: nvm_config_exists.rc != 0

- name: Add nvm configuration to .zshrc
  blockinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - NVM Configuration"
    block: |
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
      [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
    create: yes
  when: nvm_config_exists.rc != 0

- name: Source .zshrc to load nvm in current session
  shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm --version
  register: nvm_version_check
  failed_when: false
  changed_when: false
  when: nvm_installed.stat.exists or not nvm_installed.stat.exists

- name: Display nvm installation status
  debug:
    msg: "üü¢ Node Version Manager: {{ 'INSTALLED' if nvm_version_check.rc == 0 else 'MISSING' }} {{ '(v' + nvm_version_check.stdout + ')' if nvm_version_check.rc == 0 else '' }}"

# === NODE.JS AND NPM GLOBAL PACKAGES ===
- name: Install latest LTS Node.js via nvm
  shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm install --lts
    nvm use --lts
    nvm alias default lts/*
  when: nvm_version_check.rc == 0
  register: node_install_result
  changed_when: "'already installed' not in node_install_result.stdout"

- name: Check which npm global packages are already installed
  shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    npm list -g --depth=0 {{ item }} 2>/dev/null
  register: npm_package_check
  failed_when: false
  changed_when: false
  loop: "{{ npm_global_packages }}"
  when: nvm_version_check.rc == 0

- name: Display npm package status
  debug:
    msg: "{{ item.item }}: {{ 'INSTALLED' if item.rc == 0 else 'MISSING' }}"
  loop: "{{ npm_package_check.results }}"
  when:
    - nvm_version_check.rc == 0
    - npm_package_check.results is defined
    - item.rc != 0  # Only show missing packages

- name: Install missing npm global packages
  shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    npm install -g {{ item.item }}
  when:
    - nvm_version_check.rc == 0
    - npm_package_check.results is defined
    - item.rc != 0
  loop: "{{ npm_package_check.results }}"

- name: Verify npm global packages installation
  shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    npm list -g --depth=0
  register: npm_global_list
  failed_when: false
  changed_when: false
  when: nvm_version_check.rc == 0

- name: NPM global packages summary
  debug:
    msg: |
      üì¶ NPM Global Packages Summary:
      ‚Ä¢ Total packages: {{ npm_global_packages | length }}
      ‚Ä¢ Successfully installed: {{ npm_global_list.stdout_lines | select('match', '.*@.*') | list | length }} packages
  when: nvm_version_check.rc == 0 and npm_global_list.stdout is defined

# === PYTHON DEVELOPMENT TOOLS ===
- name: Check if pip3 is working properly
  shell: python3 -m pip --version
  register: pip3_check
  failed_when: false
  changed_when: false

- name: Check if pipx is already installed
  shell: pipx --version
  register: pipx_check
  failed_when: false
  changed_when: false

- name: Python development tools status
  debug:
    msg: |
      üêç Python Development Tools:
      ‚Ä¢ pip3: {{ 'WORKING' if pip3_check.rc == 0 else 'NOT WORKING' }}
      ‚Ä¢ pipx: {{ 'INSTALLED' if pipx_check.rc == 0 else 'MISSING' }}

- name: Install pipx via pip3
  shell: python3 -m pip install --user pipx
  when:
    - pip3_check.rc == 0
    - pipx_check.rc != 0
  register: pipx_install_result

- name: Configure pipx environment
  shell: |
    export PATH="$HOME/.local/bin:$PATH"
    pipx ensurepath --force
  when:
    - pip3_check.rc == 0
    - (pipx_check.rc != 0 or pipx_install_result is defined)
  register: pipx_config_result
  failed_when: false

- name: Verify pipx installation
  shell: |
    export PATH="$HOME/.local/bin:$PATH"
    pipx --version
  register: pipx_verify
  failed_when: false
  changed_when: false
  when: pip3_check.rc == 0

- name: Check which pipx packages are already installed
  shell: |
    export PATH="$HOME/.local/bin:$PATH"
    pipx list | grep "{{ item }}" || echo "NOT_FOUND"
  register: pipx_package_check
  failed_when: false
  changed_when: false
  loop:
    - community-ansible-dev-tools
    - ansible-lint
  when: pipx_verify.rc == 0

- name: Display pipx package status
  debug:
    msg: "{{ item.item }}: {{ 'INSTALLED' if 'NOT_FOUND' not in item.stdout else 'MISSING' }}"
  loop: "{{ pipx_package_check.results }}"
  when:
    - pipx_verify.rc == 0
    - pipx_package_check.results is defined
    - "'NOT_FOUND' in item.stdout"  # Only show missing packages

- name: Install missing pipx packages
  shell: |
    export PATH="$HOME/.local/bin:$PATH"
    pipx install {{ item.item }}
  when:
    - pipx_verify.rc == 0
    - pipx_package_check.results is defined
    - "'NOT_FOUND' in item.stdout"
  loop: "{{ pipx_package_check.results }}"
  register: pipx_install_packages

- name: Verify pipx packages installation
  shell: |
    export PATH="$HOME/.local/bin:$PATH"
    {{ item }} --version 2>/dev/null || echo "COMMAND_NOT_FOUND"
  register: pipx_tools_verify
  failed_when: false
  changed_when: false
  loop:
    - community-ansible-dev-tools
    - ansible-lint
  when: pipx_verify.rc == 0

- name: Pipx tools summary
  debug:
    msg: |
      üîß Pipx Development Tools Summary:
      ‚Ä¢ community-ansible-dev-tools: {{ 'ACCESSIBLE' if pipx_tools_verify.results[0].stdout and 'COMMAND_NOT_FOUND' not in pipx_tools_verify.results[0].stdout else 'NOT_IN_PATH' }}
      ‚Ä¢ ansible-lint: {{ 'ACCESSIBLE' if pipx_tools_verify.results[1].stdout and 'COMMAND_NOT_FOUND' not in pipx_tools_verify.results[1].stdout else 'NOT_IN_PATH' }}
  when: pipx_verify.rc == 0 and pipx_tools_verify.results is defined

# === GO INSTALLATION ===
- name: Check if Go is installed with correct version
  shell: go version 2>/dev/null | grep "go1.21"
  register: go_version_check
  failed_when: false
  changed_when: false

- name: Detect CPU architecture for Go download
  shell: uname -m
  register: cpu_arch_go
  changed_when: false
  when: go_version_check.rc != 0

- name: Set Go download URL based on architecture
  set_fact:
    go_download_url: "https://go.dev/dl/go1.21.5.darwin-{{ 'arm64' if cpu_arch_go.stdout == 'arm64' else 'amd64' }}.pkg"
  when: go_version_check.rc != 0

- name: Download Go installer
  get_url:
    url: "{{ go_download_url }}"
    dest: "{{ ansible_env.HOME }}/Downloads/go.pkg"
    mode: '0644'
  when: go_version_check.rc != 0

- name: Install Go
  shell: sudo installer -pkg "{{ ansible_env.HOME }}/Downloads/go.pkg" -target /
  when: go_version_check.rc != 0
  become: yes

- name: Clean up Go installer
  file:
    path: "{{ ansible_env.HOME }}/Downloads/go.pkg"
    state: absent
  when: go_version_check.rc != 0

# === ZELLIJ INSTALLATION ===
- name: Check if Zellij is installed
  shell: zellij --version
  register: zellij_check
  failed_when: false
  changed_when: false

- name: Install Zellij
  shell: bash <(curl -L https://zellij.dev/launch)
  when: zellij_check.rc != 0

# === MAC APP STORE APPLICATIONS ===
- name: Check Mac App Store applications
  stat:
    path: "{{ item.path }}"
  register: mac_app_store_check
  loop: "{{ mac_app_store_apps }}"

- name: Display Mac App Store app status
  debug:
    msg: "{{ item.item.name }}: {{ 'INSTALLED' if item.stat.exists else 'MISSING (install manually via App Store)' }}"
  loop: "{{ mac_app_store_check.results }}"

# === SYSTEM CONFIGURATION ===
- name: Check current Finder settings
  shell: |
    defaults read com.apple.finder AppleShowAllFiles 2>/dev/null || echo "false"
    defaults read com.apple.Finder AppleShowFilenameExtensions 2>/dev/null || echo "false"
  register: finder_settings
  changed_when: false

- name: Configure Finder settings
  shell: |
    defaults write com.apple.finder AppleShowAllFiles TRUE
    defaults write com.apple.Finder AppleShowFilenameExtensions -bool true
    killall Finder
  when: "'TRUE' not in finder_settings.stdout or 'true' not in finder_settings.stdout"

# === FINAL SOFTWARE INVENTORY REPORT ===
- name: macOS platform setup completed
  debug:
    msg: |
      ‚úÖ macOS platform setup completed successfully!

      Software inventory managed:
      ‚Ä¢ Homebrew packages: {{ homebrew_packages | length }}
      ‚Ä¢ Homebrew casks: {{ homebrew_casks | length }}
      ‚Ä¢ NPM global packages: {{ npm_global_packages | length }}
      ‚Ä¢ Python dev tools: pipx, community-ansible-dev-tools, ansible-lint
      ‚Ä¢ Mac App Store apps: {{ mac_app_store_apps | length }}
      ‚Ä¢ Manual installations: {{ manual_installations | length }}

      All idempotent checks preserved from original macsible.yaml
