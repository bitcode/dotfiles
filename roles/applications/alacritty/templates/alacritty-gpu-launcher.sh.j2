#!/bin/bash
# GPU-Optimized Alacritty Launcher
# Auto-generated by Ansible for {{ ansible_hostname }}
# 
# This script automatically configures the optimal GPU environment
# for Alacritty based on detected hardware configuration.
#
# System Configuration:
# - GPUs Detected: {{ gpu_info.count }}
{% if gpu_info.nvidia_detected %}
# - NVIDIA: {{ gpu_info.nvidia_model }}
{% endif %}
{% if gpu_info.amd_detected %}
# - AMD: {{ gpu_info.amd_model }}
{% endif %}
{% if gpu_info.intel_detected %}
# - Intel: {{ gpu_info.intel_model }}
{% endif %}
# - Optimal Driver: {{ alacritty_gpu_config.optimal_driver }}
# - System Type: {{ alacritty_gpu_config.system_type }}

# Set optimal GPU environment variables
{% if alacritty_gpu_config.mesa_loader_override %}
export MESA_LOADER_DRIVER_OVERRIDE="{{ alacritty_gpu_config.mesa_loader_override }}"
{% endif %}

# Essential stability settings for multi-GPU systems
{% if (gpu_info.count | int) > 1 %}
# Disable problematic features that cause memory issues
export MESA_SHADER_CACHE_DISABLE=1
{% endif %}

# Debug information (only shown if ALACRITTY_GPU_DEBUG is set)
if [ "${ALACRITTY_GPU_DEBUG:-0}" = "1" ]; then
    echo "ðŸ”§ Alacritty GPU Configuration Debug Info"
    echo "========================================"
    echo "System: {{ ansible_hostname }}"
    echo "GPU Count: {{ gpu_info.count }}"
    echo "Optimal Driver: {{ alacritty_gpu_config.optimal_driver }}"
    echo ""
    echo "Environment Variables:"
{% if alacritty_gpu_config.mesa_loader_override %}
    echo "  MESA_LOADER_DRIVER_OVERRIDE={{ alacritty_gpu_config.mesa_loader_override }}"
{% endif %}
{% for key, value in alacritty_gpu_config.additional_env_vars.items() %}
{% if value %}
    echo "  {{ key }}={{ value }}"
{% endif %}
{% endfor %}
    echo ""
    echo "GPU Hardware:"
{% if gpu_info.nvidia_detected %}
    echo "  NVIDIA: {{ gpu_info.nvidia_model }}"
{% endif %}
{% if gpu_info.amd_detected %}
    echo "  AMD: {{ gpu_info.amd_model }}"
{% endif %}
{% if gpu_info.intel_detected %}
    echo "  Intel: {{ gpu_info.intel_model }}"
{% endif %}
    echo ""
    echo "OpenGL Info:"
    glxinfo | grep -E "(OpenGL vendor|OpenGL renderer|OpenGL version)" 2>/dev/null || echo "  glxinfo not available"
    echo ""
fi

# Launch Alacritty with optimized environment
exec alacritty "$@"
