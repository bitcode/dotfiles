#!/bin/bash
# System-wide MESA GPU Configuration
# Auto-generated by Ansible for {{ ansible_hostname }}
# 
# This file sets system-wide MESA environment variables to resolve
# GPU compatibility issues with applications like Alacritty.
#
# System Configuration:
# - Hostname: {{ ansible_hostname }}
# - GPUs Detected: {{ gpu_info.count }}
{% if gpu_info.nvidia_detected %}
# - NVIDIA: {{ gpu_info.nvidia_model }}
{% endif %}
{% if gpu_info.amd_detected %}
# - AMD: {{ gpu_info.amd_model }}
{% endif %}
# - Optimal Driver: {{ alacritty_gpu_config.optimal_driver }}
# - System Type: {{ alacritty_gpu_config.system_type }}

# Only set MESA configuration if not already set by user
if [ -z "$MESA_LOADER_DRIVER_OVERRIDE" ]; then
{% if alacritty_gpu_config.mesa_loader_override %}
    export MESA_LOADER_DRIVER_OVERRIDE="{{ alacritty_gpu_config.mesa_loader_override }}"
{% endif %}
fi

# Set additional stability variables for multi-GPU systems
{% if (gpu_info.count | int) > 1 %}
if [ -z "$MESA_SHADER_CACHE_DISABLE" ]; then
    export MESA_SHADER_CACHE_DISABLE=1
fi
{% endif %}

# Export variables for desktop environment sessions
{% if alacritty_gpu_config.mesa_loader_override %}
export MESA_LOADER_DRIVER_OVERRIDE="{{ alacritty_gpu_config.mesa_loader_override }}"
{% endif %}
{% if (gpu_info.count | int) > 1 %}
export MESA_SHADER_CACHE_DISABLE=1
{% endif %}
